<script setup>
import BaseTable from './components/UI/BaseTable.vue'
import BasePagination from './components/UI/BasePagination.vue'
import BaseInput from './components/UI/BaseInput.vue'
import BaseButton from './components/UI/BaseButton.vue'
import BaseSelect from './components/UI/BaseSelect.vue'
import { useSchools } from './services/schoolsApi.js'
import { getRegions } from './services/schoolsApi.js'
import { ref, onMounted, watch, computed } from 'vue'

const {
  schools,
  loading,
  error,
  totalPages,
  currentPage,
  currentRegion,
  fetchSchools,
  clearError,
} = useSchools()

const searchValue = ref('')
const errorPage = ref(1)
const regions = ref([])
const selectedRegion = ref('')
const filteredCurrentPage = ref(1)

// –î–ê–ù–ù–´–ï –î–õ–Ø –§–ò–õ–¨–¢–†–û–í
const schoolTypes = ref([
  { value: 'all', label: '–í—Å–µ –≤–∏–¥—ã' },
  { value: 'school', label: '–®–∫–æ–ª—ã' },
  { value: 'college', label: '–ö–æ–ª–ª–µ–¥–∂–∏' },
  { value: 'university', label: '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã' },
])

const statusTypes = ref([
  { value: 'all', label: '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã' },
  { value: 'active', label: '–ê–∫—Ç–∏–≤–Ω—ã–µ' },
  { value: 'inactive', label: '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ' },
])

const selectedType = ref('all')
const selectedStatus = ref('all')

// –ü–ê–ì–ò–ù–ê–¶–ò–Ø
const pageSizes = ref([10, 25, 50])
const selectedPageSize = ref(10)

// –í–´–ë–û–† –®–ö–û–õ
const selectedSchools = ref([])
const isIndeterminate = computed(() => {
  if (filteredSchools.value.length === 0) return false
  const selectedOnCurrentPage = filteredSchools.value.filter((school) =>
    selectedSchools.value.includes(school.uuid),
  ).length
  return selectedOnCurrentPage > 0 && selectedOnCurrentPage < filteredSchools.value.length
})

// –ö–û–õ–û–ù–ö–ò –¢–ê–ë–õ–ò–¶–´
const tableColumns = ref([
  { key: 'name', label: '–ù–∞–∑–≤–∞–Ω–∏–µ', sortable: true },
  { key: 'region', label: '–†–µ–≥–∏–æ–Ω', sortable: true },
  { key: 'address', label: '–ê–¥—Ä–µ—Å', sortable: false },
  { key: 'education_level', label: '–£—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è', sortable: true },
])
let isAutoLoading = false
// –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
const filteredSchools = computed(() => {
  if (selectedStatus.value === 'all') {
    return schools.value
  }

  console.log('üîç –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –°–¢–ê–¢–£–°–£:', selectedStatus.value)

  const filtered = schools.value.filter((school) => {
    const schoolStatus = school.status || '–ù–µ—Ç —Å—Ç–∞—Ç—É—Å–∞'

    if (selectedStatus.value === 'active') {
      return schoolStatus === '–î–µ–π—Å—Ç–≤—É—é—â–µ–µ'
    } else if (selectedStatus.value === 'inactive') {
      return schoolStatus === '–ù–µ–¥–µ–π—Å—Ç–≤—É—é—â–µ–µ'
    }

    return false
  })

  console.log('‚úÖ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ —à–∫–æ–ª:', filtered.length, '–∏–∑', schools.value.length)

  return filtered
})
// –§–£–ù–ö–¶–ò–Ø –î–û–ì–†–£–ó–ö–ò –î–õ–Ø –§–ò–õ–¨–¢–†–û–í
const loadMoreForFilter = async () => {
  if (isAutoLoading) return

  isAutoLoading = true
  const nextPage = currentPage.value + 1

  try {
    console.log(`üì• –î–æ–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É ${nextPage} –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞`)
    await fetchSchools(nextPage, selectedPageSize.value, currentRegion.value, true)

    console.log(`‚úÖ –î–æ–≥—Ä—É–∂–µ–Ω–æ. –í—Å–µ–≥–æ —à–∫–æ–ª: ${schools.value.length}`)
  } catch (err) {
    console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–≥—Ä—É–∑–∫–µ:', err.message)
  } finally {
    isAutoLoading = false
  }
}
// –ü–†–ê–í–ò–õ–¨–ù–û–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–ù–ù–´–•
const displayedSchools = computed(() => {
  if (selectedStatus.value === 'all') {
    // –î–ª—è "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" - —Ç–æ–ª—å–∫–æ —à–∫–æ–ª—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã API
    return schools.value
  } else {
    // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –ø–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
    const startIndex = (filteredCurrentPage.value - 1) * selectedPageSize.value
    const endIndex = startIndex + selectedPageSize.value
    return filteredSchools.value.slice(startIndex, endIndex)
  }
})

// –ü–†–ê–í–ò–õ–¨–ù–û–ï –ö–û–õ–ò–ß–ï–°–¢–í–û –°–¢–†–ê–ù–ò–¶
const filteredTotalPages = computed(() => {
  if (selectedStatus.value === 'all') {
    return totalPages.value
  } else {
    return Math.ceil(filteredSchools.value.length / selectedPageSize.value)
  }
})

// –¢–ï–ö–£–©–ê–Ø –°–¢–†–ê–ù–ò–¶–ê –î–õ–Ø –ü–ê–ì–ò–ù–ê–¶–ò–ò
const currentDisplayPage = computed(() => {
  return selectedStatus.value === 'all' ? currentPage.value : filteredCurrentPage.value
})
// WATCHERS
watch(selectedRegion, (newRegionId) => {
  currentPage.value = 1
  const finalRegionId = newRegionId === '' ? null : newRegionId
  fetchSchools(1, selectedPageSize.value, finalRegionId, false)
})

watch(selectedStatus, (newStatus, oldStatus) => {
  filteredCurrentPage.value = 1

  // –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É API
  if (newStatus === 'all' && oldStatus !== 'all') {
    console.log('üîÑ –í–æ–∑–≤—Ä–∞—Ç –∫ "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É')
    currentPage.value = 1
    fetchSchools(1, selectedPageSize.value, currentRegion.value, false)
  }

  // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∏–ª—å—Ç—Ä—É - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ñ–∏–ª—å—Ç—Ä–∞
  if (newStatus !== 'all' && oldStatus === 'all') {
    filteredCurrentPage.value = 1
  }
})

watch(selectedType, (newType) => {
  if (newType !== 'all') {
    alert('–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–∏–¥–∞–º —É—á—Ä–µ–∂–¥–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä.')
    selectedType.value = 'all'
  }
})
watch([selectedStatus, filteredSchools], ([newStatus, newFiltered]) => {
  if (
    newStatus !== 'all' &&
    newFiltered.length < selectedPageSize.value &&
    !loading.value &&
    !isAutoLoading &&
    schools.value.length < 200
  ) {
    // –û–≥—Ä–∞–Ω–∏—á–∏–º –¥–æ 200 —à–∫–æ–ª

    console.log('üîÑ –ê–≤—Ç–æ–¥–æ–≥—Ä—É–∑–∫–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞...')
    loadMoreForFilter()
  }
})
// –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
const handlePageSizeChange = (newSize) => {
  selectedPageSize.value = newSize
  currentPage.value = 1
  fetchSchools(1, newSize, currentRegion.value, false)
}

const handleSelectAll = (isSelected) => {
  if (isSelected) {
    const currentPageIds = displayedSchools.value.map((school) => school.uuid)
    selectedSchools.value = [...new Set([...selectedSchools.value, ...currentPageIds])]
  } else {
    const currentPageIds = displayedSchools.value.map((school) => school.uuid)
    selectedSchools.value = selectedSchools.value.filter((id) => !currentPageIds.includes(id))
  }
}

const handleSelectSchool = (schoolId, isSelected) => {
  if (isSelected) {
    if (!selectedSchools.value.includes(schoolId)) {
      selectedSchools.value.push(schoolId)
    }
  } else {
    const index = selectedSchools.value.indexOf(schoolId)
    if (index > -1) {
      selectedSchools.value.splice(index, 1)
    }
  }
}

const handleExport = () => {
  if (selectedSchools.value.length === 0) return

  const selectedData = schools.value.filter((school) => selectedSchools.value.includes(school.uuid))

  let textContent = '–≠–∫—Å–ø–æ—Ä—Ç —à–∫–æ–ª\n\n'
  selectedData.forEach((school) => {
    textContent += `–ù–∞–∑–≤–∞–Ω–∏–µ: ${school.name}\n`
    textContent += `–†–µ–≥–∏–æ–Ω: ${school.region}\n`
    textContent += `–ê–¥—Ä–µ—Å: ${school.address}\n`
    textContent += `–£—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: ${school.education_level}\n`
    textContent += '‚îÄ'.repeat(50) + '\n'
  })

  const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' })
  const url = URL.createObjectURL(blob)
  const link = document.createElement('a')
  link.href = url
  link.download = `schools_export.txt`
  link.click()

  alert(`‚úÖ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${selectedData.length} —à–∫–æ–ª –≤ TXT —Ñ–∞–π–ª`)
}

const handlePageChange = async (page) => {
  errorPage.value = page
  clearError()

  if (selectedStatus.value === 'all') {
    // –î–ª—è "–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" - –æ–±—ã—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
    await fetchSchools(page, selectedPageSize.value, currentRegion.value, false)
  } else {
    // –î–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –º–µ–Ω—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    filteredCurrentPage.value = page
  }
}

const handleFirstPage = async () => {
  clearError()
  await fetchSchools(1, selectedPageSize.value, currentRegion.value, false)
}

const handleSearch = () => {
  currentPage.value = 1
  fetchSchools(1, selectedPageSize.value, currentRegion.value, false)
}

const handleRetry = async () => {
  clearError()
  await fetchSchools(currentPage.value, selectedPageSize.value, currentRegion.value, false)
}

// –ó–ê–ì–†–£–ó–ö–ê –†–ï–ì–ò–û–ù–û–í
const loadRegions = async () => {
  try {
    regions.value = await getRegions()
    console.log('‚úÖ –†–µ–≥–∏–æ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', regions.value.length, '—à—Ç.')
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤:', error)
  }
}

// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
onMounted(async () => {
  await Promise.all([fetchSchools(1, selectedPageSize.value, null, false), loadRegions()])
})
</script>

<template>
  <div id="app">
    <h1>–¢–∞–±–ª–∏—Ü–∞ —É—á—Ä–µ–∂–¥–µ–Ω–∏–π</h1>

    <!-- –í–ï–†–•–ù–Ø–Ø –°–¢–†–û–ö–ê –§–ò–õ–¨–¢–†–û–í -->
    <div class="top-filters">
      <div class="calendar-placeholder">üìÖ 09 —è–Ω–≤–∞—Ä—è 2024 - 15 —è–Ω–≤–∞—Ä—è 2024</div>

      <div class="filter-group">
        <BaseSelect v-model="selectedType" :options="schoolTypes" placeholder="–í—Å–µ –≤–∏–¥—ã" />
      </div>

      <div class="filter-group">
        <BaseSelect v-model="selectedStatus" :options="statusTypes" placeholder="–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã" />
      </div>
    </div>

    <!-- –î–ï–ô–°–¢–í–ò–Ø –° –¢–ê–ë–õ–ò–¶–ï–ô -->
    <div class="table-actions">
      <BaseButton
        :disabled="selectedSchools.length === 0"
        @click="handleExport"
        variant="accent"
        class="download-btn"
      >
        üì• –°–ö–ê–ß–ê–¢–¨ ({{ selectedSchools.length }})
      </BaseButton>

      <div class="records-info">
        <span class="records-text">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ:</span>
        <BaseSelect
          v-model="selectedPageSize"
          :options="pageSizes.map((size) => ({ value: size, label: String(size) }))"
          @update:modelValue="handlePageSizeChange"
          class="page-size-select"
        />
      </div>
    </div>

    <!-- –§–ò–õ–¨–¢–†–´ –ü–û –†–ï–ì–ò–û–ù–ê–ú -->
    <div class="filters-section">
      <div class="filter-group">
        <label class="filter-label">–†–µ–≥–∏–æ–Ω:</label>
        <BaseSelect
          v-model="selectedRegion"
          :options="[
            { value: '', label: '–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã' },
            ...regions.map((r) => ({ value: r.id, label: r.name })),
          ]"
          placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–≥–∏–æ–Ω"
        />
      </div>
    </div>

    <!-- –ü–û–ò–°–ö -->
    <div class="search-section">
      <BaseInput v-model="searchValue" placeholder="–ü–æ–∏—Å–∫ —à–∫–æ–ª..." @input="handleSearch" />
    </div>

    <!-- –°–û–î–ï–†–ñ–ò–ú–û–ï -->
    <div v-if="loading" class="status-message">
      <div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <div v-else-if="error" class="status-message error">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3>–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞</h3>
      <p>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ errorPage }} –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>
      <p class="error-detail">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>

      <div class="button-group">
        <BaseButton @click="handleRetry" variant="primary">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</BaseButton>
        <BaseButton @click="handleFirstPage" variant="secondary">–ù–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</BaseButton>
      </div>
    </div>

    <div v-else>
      <BaseTable
        :columns="tableColumns"
        :data="displayedSchools"
        :loading="loading"
        :selected-items="selectedSchools"
        :is-indeterminate="isIndeterminate"
        @select-all="handleSelectAll"
        @select-item="handleSelectSchool"
      />

      <BasePagination
        v-if="filteredTotalPages > 1"
        :current-page="currentDisplayPage"
        :total-pages="filteredTotalPages"
        @page-change="handlePageChange"
      />
    </div>
  </div>
</template>

<style scoped>
/* –°–¢–ò–õ–ò –û–°–¢–ê–Æ–¢–°–Ø –¢–ê–ö–ò–ú–ò –ñ–ï */
.top-filters {
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
  align-items: center;
  flex-wrap: wrap;
}

.calendar-placeholder {
  padding: 12px 16px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: white;
  min-width: 250px;
}

.filter-group {
  min-width: 150px;
}

.table-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 16px;
}

.records-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.records-text {
  font-size: 14px;
  color: #666;
}

.page-size-select {
  min-width: 80px;
}

.header-actions {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 20px;
}

.download-btn {
  min-width: 180px;
}

.filters-section {
  display: flex;
  gap: 24px;
  margin-bottom: 30px;
  align-items: end;
  flex-wrap: wrap;
}

.filter-label {
  font-weight: 700;
  font-size: 14px;
  color: v-bind('$color-black-1');
}

.search-section {
  margin-bottom: 30px;
  max-width: 400px;
}

.status-message {
  padding: 40px 30px;
  text-align: center;
  border-radius: 12px;
  margin: 20px 0;
}

.status-message.error {
  background: linear-gradient(135deg, #fff3f3 0%, #ffeaea 100%);
  border: 1px solid #ffcdd2;
  border-left: 4px solid #ff5252;
  color: #d32f2f;
}

.error-icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.status-message.error h3 {
  margin: 10px 0;
  font-size: 20px;
}

.status-message.error p {
  margin: 8px 0;
  font-size: 16px;
}

.error-detail {
  font-size: 14px;
  color: #666;
}

.button-group {
  margin-top: 25px;
}

.button-group button {
  margin: 0 10px;
}

.loading-spinner {
  font-size: 18px;
  color: #1976d2;
}
</style>
